@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@{
    Layout = "~/Views/Shared/AdminLayout/_AdminLayout.cshtml";
}

<!-- Đặt nội dung dashboard admin ở đây -->

<div class="grid grid-cols-12 gap-x-6">
    <div class="col-span-12 xl:col-span-4 md:col-span-6">
        @* Daily *@
        <div class="card">
            <div class="card-header !pb-0 !border-b-0">
                <h5>Daily Sales</h5>
            </div>
            <div class="card-body">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <h3 class="font-light flex items-center mb-0">
                        <i id="daily-arrow" class="feather text-[30px] mr-1.5"></i>
                        <span id="daily-amount">$ 0.00</span>
                    </h3>
                    <p id="daily-change" class="mb-0">0%</p>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mt-6 dark:bg-themedark-bodybg">
                    <div id="daily-bar" class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar"
                         style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-span-12 xl:col-span-4 md:col-span-6">
        @* Monthly *@
        <div class="card">
            <div class="card-header !pb-0 !border-b-0">
                <h5>Monthly Sales</h5>
            </div>
            <div class="card-body">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <h3 class="font-light flex items-center mb-0">
                        <i id="monthly-arrow" class="feather text-[30px] mr-1.5"></i>
                        <span id="monthly-amount">$ 0.00</span>
                    </h3>
                    <p id="monthly-change" class="mb-0">0%</p>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mt-6 dark:bg-themedark-bodybg">
                    <div id="monthly-bar" class="bg-theme-bg-2 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar"
                         style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-span-12 xl:col-span-4">
        @* Yearly *@
        <div class="card">
            <div class="card-header !pb-0 !border-b-0">
                <h5>Yearly Sales</h5>
            </div>
            <div class="card-body">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <h3 class="font-light flex items-center mb-0">
                        <i id="yearly-arrow" class="feather text-[30px] mr-1.5"></i>
                        <span id="yearly-amount">$ 0.00</span>
                    </h3>
                    <p id="yearly-change" class="mb-0">0%</p>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mt-6 dark:bg-themedark-bodybg">
                    <div id="yearly-bar" class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar"
                         style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-span-12 xl:col-span-4">
        <div class="card card-social">
            <div class="card-body border-b border-theme-border dark:border-themedark-border">
                <div class="flex items-center justify-center">
                    <div class="shrink-0">
                        <i class="fab fa-facebook-f text-primary-500 text-[36px]"></i>
                    </div>
                    <div class="grow ltr:text-right rtl:text-left">
                        <h3 class="mb-2">12,281</h3>
                        <h5 class="text-success-500 mb-0">+7.2% <span class="text-muted">Total Likes</span></h5>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-12 gap-x-6">
                    <div class="col-span-6">
                        <h6 class="text-center mb-2.5"><span class="text-muted m-r-5">Target:</span>35,098</h6>
                        <div class="w-full bg-theme-bodybg rounded-lg h-1.5 dark:bg-themedark-bodybg">
                            <div class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar" style="width: 60%"></div>
                        </div>
                    </div>
                    <div class="col-span-6">
                        <h6 class="text-center mb-2.5"><span class="text-muted m-r-5">Duration:</span>350</h6>
                        <div class="w-full bg-theme-bodybg rounded-lg h-1.5 dark:bg-themedark-bodybg">
                            <div class="bg-theme-bg-2 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar" style="width: 45%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-span-12 xl:col-span-4 md:col-span-6">
        <div class="card card-social">
            <div class="card-body border-b border-theme-border dark:border-themedark-border">
                <div class="flex items-center justify-center">
                    <div class="shrink-0">
                        <i class="fab fa-twitter text-primary-500 text-[36px]"></i>
                    </div>
                    <div class="grow ltr:text-right rtl:text-left">
                        <h3 class="mb-2">11,200</h3>
                        <h5 class="text-purple-500 mb-0">+6.2% <span class="text-muted">Total Likes</span></h5>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-12 gap-x-6">
                    <div class="col-span-6">
                        <h6 class="text-center mb-2.5"><span class="text-muted m-r-5">Target:</span>34,185</h6>
                        <div class="w-full bg-theme-bodybg rounded-lg h-1.5 dark:bg-themedark-bodybg">
                            <div class="bg-success-500 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar" style="width: 40%"></div>
                        </div>
                    </div>
                    <div class="col-span-6">
                        <h6 class="text-center mb-2.5"><span class="text-muted m-r-5">Duration:</span>800</h6>
                        <div class="w-full bg-theme-bodybg rounded-lg h-1.5 dark:bg-themedark-bodybg">
                            <div class="bg-primary-500 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar" style="width: 70%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-span-12 xl:col-span-4 md:col-span-6">
        <div class="card card-social">
            <div class="card-body border-b border-theme-border dark:border-themedark-border">
                <div class="flex items-center justify-center">
                    <div class="shrink-0">
                        <i class="fab fa-google-plus-g text-danger-500 text-[36px]"></i>
                    </div>
                    <div class="grow ltr:text-right rtl:text-left">
                        <h3 class="mb-2">10,500</h3>
                        <h5 class="text-purple-500 mb-0">+5.9% <span class="text-muted">Total Likes</span></h5>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-12 gap-x-6">
                    <div class="col-span-6">
                        <h6 class="text-center mb-2.5"><span class="text-muted m-r-5">Target:</span>25,998</h6>
                        <div class="w-full bg-theme-bodybg rounded-lg h-1.5 dark:bg-themedark-bodybg">
                            <div class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar" style="width: 80%"></div>
                        </div>
                    </div>
                    <div class="col-span-6">
                        <h6 class="text-center mb-2.5"><span class="text-muted m-r-5">Duration:</span>900</h6>
                        <div class="w-full bg-theme-bodybg rounded-lg h-1.5 dark:bg-themedark-bodybg">
                            <div class="bg-theme-bg-2 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]" role="progressbar" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-span-12 xl:col-span-4 md:col-span-6">
        <div class="card user-list">
            <div class="card-header">
                <h5>Rating</h5>
            </div>
            <div class="card-body">
                <div class="flex items-center justify-between gap-1 mb-5">
                    <h2 class="font-light flex items-center m-0">
                        4.7
                        <i class="fas fa-star text-[10px] ml-2.5 text-warning-500"></i>
                    </h2>
                    <h6 class="flex items-center m-0">
                        0.4
                        <i class="fas fa-caret-up text-success text-[22px] ml-2.5"></i>
                    </h6>
                </div>

                <div class="flex items-center justify-between gap-2 mb-2">
                    <h6 class="flex items-center gap-1">
                        <i class="fas fa-star text-[10px] mr-2.5 text-warning-500"></i>
                        5
                    </h6>
                    <h6>384</h6>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mb-6 mt-3 dark:bg-themedark-bodybg">
                    <div class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]"
                         role="progressbar"
                         style="width: 70%"></div>
                </div>

                <div class="flex items-center justify-between gap-2 mb-2">
                    <h6 class="flex items-center gap-1">
                        <i class="fas fa-star text-[10px] mr-2.5 text-warning-500"></i>
                        4
                    </h6>
                    <h6>145</h6>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mb-6 mt-3 dark:bg-themedark-bodybg">
                    <div class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]"
                         role="progressbar"
                         style="width: 35%"></div>
                </div>

                <div class="flex items-center justify-between gap-2 mb-2">
                    <h6 class="flex items-center gap-1">
                        <i class="fas fa-star text-[10px] mr-2.5 text-warning-500"></i>
                        3
                    </h6>
                    <h6>24</h6>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mb-6 mt-3 dark:bg-themedark-bodybg">
                    <div class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]"
                         role="progressbar"
                         style="width: 25%"></div>
                </div>

                <div class="flex items-center justify-between gap-2 mb-2">
                    <h6 class="flex items-center gap-1">
                        <i class="fas fa-star text-[10px] mr-2.5 text-warning-500"></i>
                        2
                    </h6>
                    <h6>1</h6>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mb-6 mt-3 dark:bg-themedark-bodybg">
                    <div class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]"
                         role="progressbar"
                         style="width: 10%"></div>
                </div>

                <div class="flex items-center justify-between gap-2 mb-2">
                    <h6 class="flex items-center gap-1">
                        <i class="fas fa-star text-[10px] mr-2.5 text-warning-500"></i>
                        1
                    </h6>
                    <h6>0</h6>
                </div>
                <div class="w-full bg-theme-bodybg rounded-lg h-1.5 mt-4 dark:bg-themedark-bodybg">
                    <div class="bg-theme-bg-1 h-full rounded-lg shadow-[0_10px_20px_0_rgba(0,0,0,0.3)]"
                         role="progressbar"
                         style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-span-12 xl:col-span-8 md:col-span-6">
        <div class="card table-card">
            <div class="card-header">
                <h5>Recent Users</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <tbody>
                            <tr class="unread">
                                <td>
                                    <img class="rounded-full max-w-10" style="width: 40px" src="~/Admin/dist/assets/images/user/avatar-1.jpg" alt="activity-user" />
                                </td>
                                <td>
                                    <h6 class="mb-1">Isabella Christensen</h6>
                                    <p class="m-0">Lorem Ipsum is simply dummy text of…</p>
                                </td>
                                <td>
                                    <h6 class="text-muted">
                                        <i class="fas fa-circle text-success text-[10px] ltr:mr-4 rtl:ml-4"></i>
                                        11 MAY 12:56
                                    </h6>
                                </td>
                                <td>
                                    <a href="#!" class="badge bg-theme-bg-2 text-white text-[12px] mx-2">Reject</a>
                                    <a href="#!" class="badge bg-theme-bg-1 text-white text-[12px]">Approve</a>
                                </td>
                            </tr>
                            <tr class="unread">
                                <td>
                                    <img class="rounded-full max-w-10" style="width: 40px" src="~/Admin/dist/assets/images/user/avatar-2.jpg" alt="activity-user" />
                                </td>
                                <td>
                                    <h6 class="mb-1">Mathilde Andersen</h6>
                                    <p class="m-0">Lorem Ipsum is simply dummy text of…</p>
                                </td>
                                <td>
                                    <h6 class="text-muted">
                                        <i class="fas fa-circle text-danger text-[10px] ltr:mr-4 rtl:ml-4"></i>
                                        11 MAY 10:35
                                    </h6>
                                </td>
                                <td>
                                    <a href="#!" class="badge bg-theme-bg-2 text-white text-[12px] mx-2">Reject</a>
                                    <a href="#!" class="badge bg-theme-bg-1 text-white text-[12px]">Approve</a>
                                </td>
                            </tr>
                            <tr class="unread">
                                <td>
                                    <img class="rounded-full max-w-10" style="width: 40px" src="~/Admin/dist/assets/images/user/avatar-3.jpg" alt="activity-user" />
                                </td>
                                <td>
                                    <h6 class="mb-1">Karla Sorensen</h6>
                                    <p class="m-0">Lorem Ipsum is simply dummy text of…</p>
                                </td>
                                <td>
                                    <h6 class="text-muted">
                                        <i class="fas fa-circle text-success text-[10px] ltr:mr-4 rtl:ml-4"></i>
                                        9 MAY 17:38
                                    </h6>
                                </td>
                                <td>
                                    <a href="#!" class="badge bg-theme-bg-2 text-white text-[12px] mx-2">Reject</a>
                                    <a href="#!" class="badge bg-theme-bg-1 text-white text-[12px]">Approve</a>
                                </td>
                            </tr>
                            <tr class="unread">
                                <td>
                                    <img class="rounded-full max-w-10" style="width: 40px" src="~/Admin/dist/assets/images/user/avatar-1.jpg" alt="activity-user" />
                                </td>
                                <td>
                                    <h6 class="mb-1">Ida Jorgensen</h6>
                                    <p class="m-0">Lorem Ipsum is simply dummy text of…</p>
                                </td>
                                <td>
                                    <h6 class="text-muted f-w-300">
                                        <i class="fas fa-circle text-danger text-[10px] ltr:mr-4 rtl:ml-4"></i>
                                        19 MAY 12:56
                                    </h6>
                                </td>
                                <td>
                                    <a href="#!" class="badge bg-theme-bg-2 text-white text-[12px] mx-2">Reject</a>
                                    <a href="#!" class="badge bg-theme-bg-1 text-white text-[12px]">Approve</a>
                                </td>
                            </tr>
                            <tr class="unread">
                                <td>
                                    <img class="rounded-full max-w-10" style="width: 40px" src="~/Admin/dist/assets/images/user/avatar-2.jpg" alt="activity-user" />
                                </td>
                                <td>
                                    <h6 class="mb-1">Albert Andersen</h6>
                                    <p class="m-0">Lorem Ipsum is simply dummy text of…</p>
                                </td>
                                <td>
                                    <h6 class="text-muted">
                                        <i class="fas fa-circle text-success text-[10px] ltr:mr-4 rtl:ml-4"></i>
                                        21 July 12:56
                                    </h6>
                                </td>
                                <td>
                                    <a href="#!" class="badge bg-theme-bg-2 text-white text-[12px] mx-2">Reject</a>
                                    <a href="#!" class="badge bg-theme-bg-1 text-white text-[12px]">Approve</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- [ Main Content ] end -->

<script>
    document.addEventListener('DOMContentLoaded', () => {
      // ====== Helpers chung ======
      const $ = (s) => document.querySelector(s);

      // Ép số an toàn: null/NaN -> 0
      const num = (v) => {
        const n = typeof v === 'string' ? Number(v.replace(/[, ]/g,'')) : Number(v);
        return Number.isFinite(n) ? n : 0;
      };

      // Tính % thay đổi nếu server không trả sẵn
      function computeChangePct(current, previous){
        const cur = num(current), prev = num(previous);
        if (prev <= 0) return cur > 0 ? 100 : 0;
        return Math.round(((cur - prev) / prev) * 10000) / 100; // làm tròn 2 số
      }

      // Format tiền (mặc định USD, anh đổi tuỳ ý)
      function formatMoneyUSD(v){
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num(v));
      }

      // Đổi icon/màu mũi tên theo % thay đổi
      function toggleArrow(el, pct){
        if(!el) return;
        const up = num(pct) >= 0;
        el.classList.remove('text-success-500','text-danger-500','icon-arrow-up','icon-arrow-down');
        el.classList.add(up ? 'text-success-500' : 'text-danger-500');
        el.classList.add(up ? 'icon-arrow-up' : 'icon-arrow-down');
      }

      // Bind dữ liệu cho từng card
      function bindCard(prefix, stat, barThemeClass){
        const amountEl = $(`#${prefix}-amount`);
        const changeEl = $(`#${prefix}-change`);
        const barEl    = $(`#${prefix}-bar`);
        const arrowEl  = $(`#${prefix}-arrow`);

        if(!stat){
          console.warn(`[${prefix}] stat is missing`);
          return;
        }

        // Đảm bảo có current/previous/changePct
        const current  = num(stat.current);
        const previous = num(stat.previous);
        const changePct = (stat.changePct !== undefined && stat.changePct !== null)
            ? num(stat.changePct)
            : computeChangePct(current, previous);

        if(amountEl) amountEl.textContent = formatMoneyUSD(current);
        if(changeEl) changeEl.textContent = `${changePct}%`;

        if(barEl){
          // chiều rộng theo |%|, tối đa 100
          barEl.style.width = Math.min(Math.abs(changePct), 100) + '%';
          if(barThemeClass){
            barEl.classList.remove('bg-theme-bg-1','bg-theme-bg-2');
            barEl.classList.add(barThemeClass);
          }
        }
        toggleArrow(arrowEl, changePct);

        // Debug log
        console.table([{prefix, current, previous, changePct}]);
      }

      // Chuẩn hoá payload từ API (hỗ trợ PascalCase/camelCase)
      function normalizeStat(s){
        if(!s) return { current:0, previous:0, changePct:0 };
        // Cho phép cả Current/Previous/ChangePct hoặc current/previous/changePct
        const current   = s.current   ?? s.Current   ?? 0;
        const previous  = s.previous  ?? s.Previous  ?? 0;
        const changePct = s.changePct ?? s.ChangePct; // có thể undefined -> sẽ tự tính
        return { current: num(current), previous: num(previous), changePct };
      }

      function normalizePayload(data){
        // Cho phép cả Daily/Monthly/Yearly hoặc daily/monthly/yearly
        const d = data?.daily   ?? data?.Daily;
        const m = data?.monthly ?? data?.Monthly;
        const y = data?.yearly  ?? data?.Yearly;
        return {
          daily:   normalizeStat(d),
          monthly: normalizeStat(m),
          yearly:  normalizeStat(y),
        };
      }

      async function loadSales(){
        try{
          const res = await fetch('/api/dashboard/sales', { cache: 'no-store' });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const raw = await res.json();

          // In toàn bộ raw để anh kiểm tra key
          console.log('RAW /api/dashboard/sales:', raw);

          const data = normalizePayload(raw);
          console.log('NORMALIZED:', data);

          // Bind từng card (đúng ID anh đang dùng)
          bindCard('daily',   data.daily,   'bg-theme-bg-1');
          bindCard('monthly', data.monthly, 'bg-theme-bg-2');
          bindCard('yearly',  data.yearly,  'bg-theme-bg-1');
        }catch(err){
          console.error('Load sales failed:', err);
        }
      }

      loadSales();
    });
</script>


