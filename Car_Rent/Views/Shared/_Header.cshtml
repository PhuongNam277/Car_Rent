@{
    var username = User.Identity!.Name;
    var userId = User.Claims.FirstOrDefault(c => c.Type == "UserId")?.Value;

}
@if (User.IsInRole("Staff"))
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const badge = document.getElementById('supportBadge');
          const queueIds = new Set();

          function updateBadge(){ if (badge) badge.textContent = String(queueIds.size); }

          function toast(msg) {
            const t = document.createElement('div');
            t.className = 'position-fixed end-0 top-0 m-3 p-3 bg-dark text-white rounded-3 shadow';
            t.style.zIndex = 1080;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(()=> t.remove(), 3500);
          }

          const conn = new signalR.HubConnectionBuilder()
            .withUrl('/hubs/chat')
            .withAutomaticReconnect()
            .build();

          // Seed hàng đợi và các phòng đã gán cho tôi
          conn.on('SeedQueue', items => { items?.forEach(i => queueIds.add(i.conversationId)); updateBadge(); });
          conn.on('SeedAssigned', items => {
              // Không cộng vào queueIds (đây là các phòng đã gán), chỉ hiển thị thông tin nếu muốn
              if (items && items.length) toast(`Có ${items.length} cuộc chat đang mở đã gán cho bạn.`);
          });

          // Khách mới → tăng badge + toast
          conn.on('NewConversation', i => { queueIds.add(i.conversationId); updateBadge(); toast('Khách mới yêu cầu hỗ trợ'); });

          // Có staff khác nhận → giảm badge
          conn.on('ConversationAssigned', e => { queueIds.delete(e.conversationId); updateBadge(); });

          // Khách quay lại phòng đã gán cho tôi
          conn.on('CustomerBack', e => { toast('Khách vừa quay lại phòng chat của bạn'); });

          conn.start().catch(console.error);
        });
    </script>
}


<div class="container-fluid nav-bar sticky-top px-0 px-lg-4 py-2 py-lg-0">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light">
            <a href=""  class="navbar-brand p-0">
                @* <h1 class="display-6 text-primary" asp-controller="Home"><i class="fas fa-car-alt me-3"></i></i>Cental</h1> *@
                <a asp-controller="Main" asp-action="Index" class="display-6 text-primary">
                    <i class="fas fa-car-alt me-3"></i>Cental
                </a>
                <!-- <img src="img/logo.png" alt="Logo"> -->
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="fa fa-bars"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav mx-auto py-0">
                    <a asp-controller="Main" asp-action="Index" class="nav-item nav-link @(ViewData["ActivePage"]?.ToString() == "Home" ? "active" : "")">Home</a>
                    <a asp-controller="About" asp-action="Index" class="nav-item nav-link @(ViewData["ActivePage"]?.ToString() == "About" ? "active" : "")">About</a>
                    <a asp-controller="Service" asp-action="Index" class="nav-item nav-link @(ViewData["ActivePage"]?.ToString() == "Service" ? "active" : "")">Service</a>
                    <a asp-controller="Blog" asp-action="Index" class="nav-item nav-link @(ViewData["ActivePage"]?.ToString() == "Blog" ? "active" : "")">Blog</a>
                    @if (User.IsInRole("Staff"))
                    {
                        <a asp-controller="Chat" asp-action="Inbox" class="nav-item nav-link @(ViewData["ActivePage"]?.ToString() == "Chat Inbox" ? "active" : "")">
                            Chat Inbox
                            <span id="supportBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger ">0</span>
                        </a>
                    }
                    else if (User.Identity.IsAuthenticated)
                    {
                        <a asp-controller="Chat" asp-action="History" class="nav-item nav-link @(ViewData["ActivePage"]?.ToString() == "Chat" ? "active" : "")">
                            Chat
                            <span id="userChatBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                        </a>
                        
                    }


                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link @(ViewData["ActivePage"]?.ToString() == "Pages" ? "active" : "") dropdown-toggle" data-bs-toggle="dropdown">Pages</a>
                        <div class="dropdown-menu m-0">
                            <a asp-controller="Feature" asp-action="Index" class="dropdown-item">Our Feature</a>
                            <a asp-controller="Car" asp-action="Index" class="dropdown-item">Our Cars</a>
                            <a asp-controller="Team" asp-action="Index" class="dropdown-item">Our Team</a>
                            <a asp-controller="Testimonial" asp-action="Index" class="dropdown-item">Testimonial</a>
                        </div>
                    </div>
                    <a asp-controller="Contact" asp-action="Index" class="nav-item nav-link @(ViewData["ActivePage"]?.ToString() == "Contact" ? "active" : "")">Contact</a>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link @(ViewData["ActivePage"]?.ToString() == "Pages" ? "active" : "") dropdown-toggle" data-bs-toggle="dropdown">More</a>
                        <div class="dropdown-menu m-0">
                            <a asp-controller="MyReservation" asp-action="Index" class="dropdown-item">My Reservations</a>
                            <a asp-controller="MyProfile" asp-action="Index" class="dropdown-item">My Profile</a>
                            <a asp-controller="Login" asp-action="Logout" class="dropdown-item">Log out</a>
                        </div>
                    </div>
                    @if (User.IsInRole("Owner") || User.IsInRole("Staff"))
                    {
                        <partial name="_TenantSwitcher"></partial>
                    }

                @if (!string.IsNullOrEmpty(username))
                {
                        <span class="btn btn-primary rounded-pill py-2 px-4 disabled d-inline-flex align-items-center" style="pointer-events: none;">
                            @($"Hi, {username}")
                        </span>
                }
                else
                {
                        <a asp-controller="Login" asp-action="Index" class="btn btn-primary rounded-pill py-2 px-4 d-inline-flex align-items-center">
                        Login
                    </a>
                }


                @if (username == "Admin")
                {
                    <a asp-controller="Admin" asp-action="Index" class="btn btn-primary rounded-pill py-2 px-4 d-inline-flex align-items-center" style="margin-left: 12px">
                        <text>Manage</text>
                    </a>
                }
            </div>
        </nav>
    </div>
</div>