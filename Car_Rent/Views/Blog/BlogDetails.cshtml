@model Car_Rent.ViewModels.Blog.BlogDetailsViewModel
@{
    ViewData["Title"] = Model.Blog.Title;
    Layout = "~/Views/Shared/MainLayout.cshtml";
    int? currentUserId = ViewBag.CurrentUserId as int?;
    bool isAdmin = ViewBag.IsAdmin as bool? ?? false;
}

<!-- Header -->
<div class="container-fluid bg-breadcrumb">
    <div class="container text-center py-5" style="max-width: 900px;">
        <h4 class="text-white display-4 mb-4 wow fadeInDown" data-wow-delay="0.1s">Blog Details</h4>
        <ol class="breadcrumb d-flex justify-content-center mb-0 wow fadeInDown" data-wow-delay="0.3s">
            <li class="breadcrumb-item"><a asp-controller="Main" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Blog" asp-action="Index">Blog</a></li>
            <li class="breadcrumb-item active text-primary">@Model.Blog.Title</li>
        </ol>
    </div>
</div>

<div class="container py-5">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="blog-item">
        <div class="blog-img">
          <img src="@Model.Blog.ImageUrl" class="img-fluid rounded-top w-100" alt="Image">
        </div>
        <div class="blog-content rounded-bottom p-4">
          <div class="blog-date">@Model.Blog.PublishedDate?.ToString("dd MMM yyyy")</div>
          <div class="blog-comment my-3 d-flex gap-3">
            <div class="small"><span class="fa fa-user text-primary"></span><span class="ms-2">@Model.Blog.Author?.Username</span></div>
            <div class="small"><span class="fa fa-comment-alt text-primary"></span><span class="ms-2">@Model.Comments.Count bình luận</span></div>
          </div>

          <h2 class="mb-3">@Model.Blog.Title</h2>
          <div class="mb-4">
            @Html.Raw(Model.Blog.Content)
          </div>

          <hr />

          <h4 id="comments" class="mb-3">Comments (@Model.Comments.Count)</h4>

          @if (!Model.Comments.Any())
          {
              <div class="text-muted mb-4">No comments yet.</div>
          }
          else
          {
              <div class="list-group mb-4">
                  @foreach (var c in Model.Comments)
                  {
                      var canManage = isAdmin || (currentUserId != null && c.UserId.ToString() != null && c.UserId == currentUserId);
                      <div id="comment-@c.CommentId" class="list-group-item border-0 border-bottom">
                          <div class="d-flex align-items-center justify-content-between">
                              <div style="color: darkred;" class="fw-semibold">@((c.IsAnonymous) ? "Anonymous" : c.AuthorName)</div>
                              <div class="d-flex align-items-center gap-3">
                                  <div class="text-muted small">
                                      @c.CreatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                      @if (c.UpdatedAt.ToString() != null)
                                      {
                                          <span title="Edited"> • edited</span>
                                      }
                                  </div>
                                  @if (canManage)
                                  {
                                      <div class="small">
                                          <a asp-action="EditComment" asp-route-id="@c.CommentId" class="me-2">Edit</a>
                                          <form asp-action="DeleteComment" method="post" class="d-inline"
                                                onsubmit="return confirm('Delete this comment?');">
                                              @Html.AntiForgeryToken()
                                              <input type="hidden" name="id" value="@c.CommentId" />
                                              <input type="hidden" name="blogId" value="@Model.Blog.BlogId" />
                                              <button type="submit" class="btn btn-link p-0 m-0 align-baseline text-danger">Delete</button>
                                          </form>
                                      </div>
                                  }
                              </div>
                          </div>
                          <div class="mt-2">@c.Content</div> @* Razor encode chống XSS *@
                      </div>
                  }
              </div>
          }

            <h5 class="mb-3">Add Comment</h5>
            @if (User?.Identity?.IsAuthenticated ?? false)
            {
                <form asp-action="PostComment" asp-controller="Blog" method="post">
                    @Html.AntiForgeryToken()

                    <!-- Hidden BlogId: chỉ 1 value, không bị chồng -->
                    <input type="hidden" name="NewComment.BlogId" value="@Model.Blog.BlogId" />

                    <div class="mb-3">
                        <label asp-for="NewComment.Content" class="form-label">Content</label>
                        <textarea asp-for="NewComment.Content" rows="4" class="form-control" placeholder="Write something..."></textarea>
                        <span class="text-danger" asp-validation-for="NewComment.Content"></span>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" asp-for="NewComment.IsAnonymous" id="anonCheck">
                        <label class="form-check-label" for="anonCheck">Post with anonymous</label>
                    </div>

                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>
            }
            else
            {
                <div class="alert alert-info" role="alert">
                    You need to <a asp-controller="Login" asp-action="Index" asp-route-returnUrl="@Context.Request.Path" class="alert-link">Login</a> to post comment.
                </div>
            }
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      @* Sidebar tuỳ chọn *@
    </div>
  </div>
</div>

@section Scripts{
  <partial name="_ValidationScriptsPartial" />
}
